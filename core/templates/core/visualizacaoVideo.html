{% extends 'base.html' %}

{% load crispy_forms_tags %}

{% load static %}

{% block title %} {{video.titulo}} {% endblock %}


{% block content %}
<div class="offset-1 col-10 list-div">
    <h2>{{video.titulo}}</h2>


    {% if tipo_video == 'interno' %}
        <video id="video_interno" style="width:400px;max-width:100%;" frameborder="0" controls="controls" tabindex="0" >
          <source src="../media/{{ caminho_video }}" type="video/mp4">
          <source src="../media/{{ caminho_video }}" type="video/ogg">
          <source src="../media/{{ caminho_video }}" type="video/webm">
        Seu browser não suporta o formato para reprodução do vídeo.
        </video>
    {% else %}
        <iframe id="player" width="420" height="315"
                src="{{ caminho_video }}" frameborder="0"
                allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
        </iframe>

    {% endif %}

    {% if tipo_video == 'interno' %}
        <script type='text/javascript'>

            var tempo_corrente = 0;
            var video_assistido = false;

            //__ Associ
            document.getElementById('video_interno').addEventListener('ended',fimDoVideo,false);

            //__ Obtém o tempo corrente do video que será exibido
            $(document).ready(function(){
                $.ajax(
                {
                    type:"GET",
                    url: "/obtem-usuario-video",
                    data:{
                        usuario_video_id: {{ usuario_video.id }},
                    },
                    success: function( data )
                    {
                        tempo_corrente = parseInt(data["tempo_corrente"]);
                        document.getElementById('video_interno').currentTime = tempo_corrente;
                    }
                 })
            })

            //__ Função para atualizar na base de dados via Ajax algumas informações do video
            function callViewUpdateVideo(){
                tempo_corrente = $('#video_interno')[0].currentTime;
                $.ajax(
                {
                    type:"GET",
                    url: "/atualiza-usuario-video",
                    data:{
                        usuario_video_id: {{ usuario_video.id }},
                        tempo_corrente: tempo_corrente,
                        video_assistido: video_assistido
                    }
                 })
            }

            //__ Evento de inicio do video
            $('#video_interno').bind('play', function (e) {
                video_assistido = false;
                callViewUpdateVideo();
            });

            //__ Evento de fim do video
            function fimDoVideo(e) {
                video_assistido = true;
                callViewUpdateVideo();
            }

            $(window).on("beforeunload", function() {
                callViewUpdateVideo();
            })

        </script>
    {% else %}
        <script src="{{ src_api_video }}"></script>
    {% endif %}

    {% if tipo_video == 'youtube' %}


        <script>

            var player;
            var tempo_corrente = 0;
            var video_assistido = false;

            //__ Obtém o tempo corrente do video que será exibido
            $(document).ready(function(){
                $.ajax(
                {
                    type:"GET",
                    url: "/obtem-usuario-video",
                    data:{
                        usuario_video_id: {{ usuario_video.id }},
                    },
                    success: function( data )
                    {
                        tempo_corrente = parseInt(data["tempo_corrente"]);
                    }
                 })
            })


            //__ Cria o player especifico do Youtube
            function onYouTubeIframeAPIReady() {
                player = new YT.Player( 'player', {
                    events: { 'onReady': onPlayerReady , 'onStateChange': onPlayerStateChange }
                });
            }

            //__ Função para atualizar na base de dados via Ajax algumas informações do video
            function callViewUpdateVideo(){
                tempo_corrente = player.getCurrentTime()
                $.ajax(
                {
                    type:"GET",
                    url: "/atualiza-usuario-video",
                    data:{
                        usuario_video_id: {{ usuario_video.id }},
                        tempo_corrente: tempo_corrente,
                        video_assistido: video_assistido
                    }
                 })
            }

            //__ Método associado ao carregamento completo do player.
            //   Aqui é posicionado o video no tempo corrente da sua última execução.
            function onPlayerReady(event) {
                player.seekTo(tempo_corrente, true);
                player.pauseVideo();
            }

            //__ Método associado a troca de estado do player
            function onPlayerStateChange(event) {

                //__ Evento de inicio do video
                if (event.data == YT.PlayerState.PLAYING) {
                    tempo_corrente = player.getCurrentTime()
                    video_assistido = false;
                    callViewUpdateVideo()
                    //setInterval (callViewUpdateVideo, 5000);
                }

                //__ Evento de fim do video
                if (event.data == YT.PlayerState.ENDED) {
                    tempo_corrente = player.getCurrentTime()
                    video_assistido = true;
                    callViewUpdateVideo()
                }
            }

            //__ Método executado antes de fechar a página
            $(window).on("beforeunload", function() {
                callViewUpdateVideo()
            })


        </script>

    {% endif %}

    {% if tipo_video == 'vimeo' %}
        <script>

            var iframe = document.querySelector('#player');
            var player = new Vimeo.Player(iframe);
            var tempo_corrente = 0;
            var video_assistido = false;

            //__ Obtém o tempo corrente do video que será exibido
            $(document).ready(function(){
                $.ajax(
                {
                    type:"GET",
                    url: "/obtem-usuario-video",
                    data:{
                        usuario_video_id: {{ usuario_video.id }},
                    },
                    success: function( data )
                    {
                        tempo_corrente = parseInt(data["tempo_corrente"]);
                    }
                 })
            })

            //__ Função para atualizar na base de dados via Ajax algumas informações do video
            function callViewUpdateVideo(){
                $.ajax(
                {
                    type:"GET",
                    url: "/atualiza-usuario-video",
                    data:{
                        usuario_video_id: {{ usuario_video.id }},
                        tempo_corrente: tempo_corrente,
                        video_assistido: video_assistido
                    }
                 })
            }

            function getCurrentTime(){
              player.getCurrentTime().then(function(seconds) {
                  tempo_corrente = seconds;
                  return;
              })
            }


            //__ Evento de inicio do video
            player.on('play', function() {
                //alert('You have played the video')
                video_assistido = false;
                callViewUpdateVideo()
                setInterval (getCurrentTime, 2000);
            });

            //__ Evento de fim do video
            player.on('ended', function(){
                video_assistido = true;
                callViewUpdateVideo()
            });

            player.ready().then(function() {
                // the player is ready
                //alert('Ready');
                player.setCurrentTime(tempo_corrente)
            });


            $(window).on("beforeunload", function(e) {
                callViewUpdateVideo()
            })

        </script>
    {% endif %}
</div>
{% endblock %}